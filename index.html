<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dyfi Digital Signature </title>
<!-- Load Signature Pad and jsPDF libraries -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    /* Basic Styling for Mobile-First Design */
    body { 
        font-family: 'Inter', Arial, sans-serif; 
        background: #f4f7f9; 
        text-align: center; 
        padding: 15px; 
        color: #333;
    }
    
    /* Input Fields */
    input { 
        width: 90%; 
        max-width: 400px; 
        padding: 14px; 
        margin: 10px 0; 
        border: 1px solid #ccc; 
        border-radius: 8px; 
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        transition: border-color 0.3s;
    }
    input:focus {
        border-color: #1a73e8;
        outline: none;
    }

    /* Signature Box Container */
    #box { 
        width: 95%; 
        max-width: 800px; 
        height: 50vh; 
        border: 2px solid #333; 
        background: white; 
        position: relative; 
        margin: 15px auto;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    /* Canvas element fills the box */
    canvas { 
        width: 100%; 
        height: 100%; 
        display: block; 
    }
    
    /* Buttons Styling */
    button { 
        padding: 12px 24px; 
        margin: 8px; 
        color: white; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        font-size: 16px;
        font-weight: 600;
        transition: background-color 0.3s, transform 0.1s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    button:hover:not(:disabled) {
        transform: translateY(-1px);
        opacity: 0.9;
    }
    button:disabled { 
        background: #999; 
        cursor: not-allowed; 
        box-shadow: none;
    }
    
    /* Specific Button Colors */
    #save { background: #0a8f08; } /* Green for Send */
    #clear { background: #d32f2f; } /* Red for Clear */
    #pdfMenuBtn { background: #1a73e8; } /* Blue for Menu */

    /* Popup for PDF options */
    #pdfMenu { 
        display: none; 
        margin: 10px auto; 
        width: 90%;
        max-width: 280px;
        background: #fff; 
        padding: 15px; 
        border-radius: 12px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
        border: 1px solid #eee;
    }
    #pdfMenu button { 
        width: 100%; 
        margin: 5px 0; 
        background: #444; 
    }

    /* Message Box for alerts (instead of native alerts) */
    .message-box {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.3s;
    }
    .message-box.active {
        visibility: visible;
        opacity: 1;
    }
    .message-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        max-width: 300px;
        text-align: center;
        transform: scale(0.9);
        transition: transform 0.3s;
    }
    .message-box.active .message-content {
        transform: scale(1);
    }
    .message-content button {
        background: #1a73e8;
        margin-top: 15px;
    }
</style>
</head>
<body>

<h1>DYFI நடத்தும் E-Signature</h1>
<p>Sign the box below and email the sealed PDF document.</p>

<input id="name" placeholder="Enter Your Name">
<input id="email" type="email" placeholder="Recipient Email Address">

<div id="box">
    <canvas id="canvas"></canvas>
</div>

<div class="flex-row">
    <button id="clear">Clear Signature</button>
    <button id="pdfMenuBtn">PDF Options</button>
</div>

<div id="pdfMenu">
    <button id="previewBtn">Preview PDF</button>
    <button id="downloadBtn">Download PDF</button>
</div>

<button id="save">Send Signed PDF via Email</button>

<!-- Custom Message Box for Mobile Friendly Alerts -->
<div id="messageBox" class="message-box">
    <div class="message-content">
        <p id="messageText"></p>
        <button onclick="document.getElementById('messageBox').classList.remove('active')">OK</button>
    </div>
</div>

<script>
    // --- Utility Function: Custom Alert/Message Box ---
    function showMessage(text) {
        document.getElementById('messageText').innerText = text;
        document.getElementById('messageBox').classList.add('active');
    }

    // 1. Initialize Canvas & SignaturePad
    const canvas = document.getElementById("canvas");
    const box = document.getElementById("box");
    let signaturePad;

    // Function to handle canvas resizing and maintain signature aspect ratio
    function resizeCanvas() {
        const data = signaturePad ? signaturePad.toData() : null;
        
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = box.clientWidth * ratio;
        canvas.height = box.clientHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        
        if (!signaturePad) {
            signaturePad = new SignaturePad(canvas, { backgroundColor: "transparent", penColor: "blue" });
        } else {
            signaturePad.clear();
            // Restore data after resize
            if (data && data.length > 0) {
                signaturePad.fromData(data);
            }
        }
    }
    
    // Initialize and listen for resize events
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas(); // Initial call to set size

    document.getElementById("clear").onclick = () => signaturePad.clear();

    // 2. Core PDF Generation Function
    async function createPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("landscape", "pt", "a4"); 
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();

            const name = document.getElementById("name").value.trim() || "Unsigned User";
            
            // --- PDF CONTENT ---
            
            // 1. Add Title/Context
            pdf.setFontSize(22);
            pdf.text("Digital Signature Verification Document", 40, 40);
            
            // 2. Add Signing Info
            pdf.setFontSize(14);
            pdf.text(`Document signed by: ${name}`, 40, 65);
            pdf.text(`Date: ${new Date().toLocaleString()}`, 40, 85);
            
            // 3. Add Rectangle Border for Signature Area
            // Drawing a box for a clean, contained signature area
            const signAreaY = 100;
            const signAreaHeight = 400;
            pdf.setLineWidth(2);
            pdf.setDrawColor(50, 50, 50); // Dark Gray border
            pdf.rect(40, signAreaY, pdfWidth - 80, signAreaHeight); 

            // 4. Add Signature (if present)
            if (!signaturePad.isEmpty()) {
                const imgData = signaturePad.toDataURL("image/png");
                // Fit signature image inside the rectangle
                pdf.addImage(imgData, "PNG", 40, signAreaY, pdfWidth - 80, signAreaHeight);
            } else {
                pdf.setFontSize(18);
                pdf.setTextColor(150);
                pdf.text("NO SIGNATURE PROVIDED", pdfWidth / 2, pdfHeight / 2, { align: 'center' });
                pdf.setTextColor(0);
            }

            return pdf.output("blob");

        } catch (error) {
            console.error("PDF Generation Error:", error);
            showMessage("Error generating PDF: " + error.message);
            return null;
        }
    }

    // 3. Toggle PDF Menu
    document.getElementById("pdfMenuBtn").onclick = () => {
        const menu = document.getElementById("pdfMenu");
        // Simple toggle logic
        if (menu.style.display === "block") {
            menu.style.display = "none";
        } else {
            menu.style.display = "block";
        }
    };

    // 4. Preview Function
    document.getElementById("previewBtn").onclick = async () => {
        const pdfBlob = await createPDF();
        if (pdfBlob) {
            const url = URL.createObjectURL(pdfBlob);
            window.open(url, "_blank");
        }
    };

    // 5. Download Function
    document.getElementById("downloadBtn").onclick = async () => {
        const pdfBlob = await createPDF();
        if (pdfBlob) {
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Signed_Document_${new Date().toISOString().slice(0, 10)}.pdf`;
            a.click();
        }
    };

    // 6. Web3Forms Email Function (The Fix)
    document.getElementById("save").onclick = async () => {
        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const btn = document.getElementById("save");

        if (!name) return showMessage("Please enter your Name.");
        if (!email) return showMessage("Please enter the Recipient Email.");
        if (signaturePad.isEmpty()) return showMessage("Please sign the document before sending.");

        // UI Feedback during process
        btn.innerText = "Processing...";
        btn.disabled = true;

        const pdfBlob = await createPDF();
        
        if (!pdfBlob) {
            btn.innerText = "Send Signed PDF via Email";
            btn.disabled = false;
            return;
        }

        btn.innerText = "Sending Email...";

        // --- CORE FIX: Prepare Form Data for Reliable Attachment ---
        const filename = "signed_document.pdf";
        const formData = new FormData();
        
        // 1. Access Key (Required)
        formData.append("access_key", "6e1efc51-93b3-4ffc-8d33-a446ca6eacd8"); 
        
        // 2. Explicitly list the file name for Web3Forms to attach to the notification email
        formData.append("_attachments", filename); 
        
        // 3. Subject and User Fields
        formData.append("subject", `New Signed Document from ${name}`); 
        formData.append("name", name);
        formData.append("email", email); 
        formData.append("message", `A new digital signature document is attached. Recipient specified: ${email}`);

        // 4. The File itself: The key MUST match the name in '_attachments'
        formData.append(filename, pdfBlob, filename); 

        try {
            const response = await fetch("https://api.web3forms.com/submit", {
                method: "POST",
                body: formData
            });

            const result = await response.json();
            
            if (result.success) {
                showMessage(`Success! The PDF was sent and a confirmation email was sent to your registered Web3Forms address.`);
                signaturePad.clear();
                document.getElementById("pdfMenu").style.display = "none";
            } else {
                showMessage(`Error sending email: ${result.message}`);
                console.error("Web3Forms API Error:", result);
            }
        } catch (error) {
            showMessage("Network Error: Could not connect to the API.");
            console.error("Fetch Error:", error);
        } finally {
            // Reset UI
            btn.innerText = "Send Signed PDF via Email";
            btn.disabled = false;
        }
    };
</script>

</body>
</html>

